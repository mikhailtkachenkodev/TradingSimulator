# Trading Simulator

Симулятор торговли, моделирующий эволюцию цены с помощью геометрического броуновского движения (GBM) и торгующий по стратегии пересечения скользящих средних (EMA Crossover).

## Сборка

**Требования:** CMake 3.25+, компилятор с поддержкой C++23

```bash
# Сборка приложения
cmake -B build && cmake --build build

# Сборка с тестами
cmake -B build -DENABLE_TESTS=ON && cmake --build build
```

## Запуск

```bash
# Использует config.ini в директории исполняемого файла
./build/TradingSimulator

# Использует указанный файл конфигурации
./build/TradingSimulator path/to/config.ini
```

При первом запуске, если файл конфигурации не найден, он будет создан автоматически со значениями по умолчанию.

## Конфигурация

Файл конфигурации использует формат INI. Временные значения поддерживают суффиксы: `ns`, `us`, `ms`, `s`, `min`, `h`, `d`, `m` (месяц), `y` (год).

### Секция [Price] — параметры ценообразования

| Параметр | По умолчанию | Описание |
|----------|--------------|----------|
| `initial_price` | 100 | Начальная цена актива |
| `average_trend_value` | 0.05 | Коэффициент дрифта (μ) — средняя доходность |
| `price_variation` | 0.10 | Волатильность (σ) — степень случайных колебаний |
| `time_horizon` | 24h | Временной горизонт для нормализации расчётов |
| `min_diff_time` | 100ms | Минимальный интервал между тиками |
| `max_diff_time` | 200ms | Максимальный интервал между тиками |

### Секция [Trade] — параметры торговли

| Параметр | По умолчанию | Описание |
|----------|--------------|----------|
| `fast_ema` | 1s | Период быстрой EMA |
| `slow_ema` | 5s | Период медленной EMA |
| `min_volume` | 1 | Минимальный объём ордера |
| `max_volume` | 1000 | Максимальный объём ордера |
| `min_position` | -1000 | Минимальная позиция (лимит шорта) |
| `max_position` | 1000 | Максимальная позиция (лимит лонга) |

### Секция [Exchange] — параметры биржи

| Параметр | По умолчанию | Описание |
|----------|--------------|----------|
| `rejection_probability` | 1.0 | Вероятность отклонения ордера (0.0–100.0%) |

### Секция [Simulation] — параметры симуляции

| Параметр | По умолчанию | Описание |
|----------|--------------|----------|
| `steps_count` | 100000 | Количество тиков для генерации |
| `price_evolution_path` | output/price_evolution.csv | Путь для записи истории цен |
| `orders_log_path` | output/orders.csv | Путь для записи истории ордеров |

### Пример config.ini

```ini
[Price]
initial_price = 100
average_trend_value = 0.05
price_variation = 0.10
time_horizon = 24h
min_diff_time = 100ms
max_diff_time = 200ms

[Trade]
fast_ema = 1s
slow_ema = 5s
min_volume = 1
max_volume = 1000
min_position = -1000
max_position = 1000

[Exchange]
rejection_probability = 1.0

[Simulation]
steps_count = 100000
price_evolution_path = output/price_evolution.csv
orders_log_path = output/orders.csv
```

## Выходные данные

Симулятор создаёт два CSV-файла:

**price_evolution.csv** — история цен:
- `timestamp` — временная метка в наносекундах
- `price` — цена
- `volume` — объём

**orders.csv** — история ордеров:
- `side` — сторона (Buy/Sell)
- `price` — цена исполнения
- `volume` — объём
- `status` — статус (Executed/Rejected)
- `error_text` — текст ошибки (если есть)
- `pnl` — текущий P&L после сделки

## Как это работает

### Генерация цены (GBM)

Цена моделируется по формуле геометрического броуновского движения:

```
S(t+Δt) = S(t) × exp[(μ - σ²/2)×Δt/T + σ×√(Δt/T)×Z]
```

где:
- `S(t)` — текущая цена
- `μ` — average_trend_value (дрифт)
- `σ` — price_variation (волатильность)
- `T` — time_horizon
- `Δt` — случайный интервал между min_diff_time и max_diff_time
- `Z` — случайная величина из стандартного нормального распределения

### Торговая стратегия (EMA Crossover)

Торговый бот использует две экспоненциальные скользящие средние:
- **Быстрая EMA** — реагирует быстрее на изменения цены
- **Медленная EMA** — сглаживает краткосрочные колебания

Сигналы:
- **Покупка**: когда быстрая EMA пересекает медленную снизу вверх
- **Продажа**: когда быстрая EMA пересекает медленную сверху вниз

### Управление ордерами

OrderManager отслеживает текущую позицию и следит за соблюдением лимитов (min_position/max_position). ExchangeApi симулирует биржу с настраиваемой вероятностью отклонения ордеров. После каждой сделки рассчитывается P&L.

## Тестирование

```bash
# Запуск тестов (требуется сборка с -DENABLE_TESTS=ON)
cd build && ctest --output-on-failure
```
